generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  PATIENT
  PSYCHOLOGIST
  ADMIN
}

model User {
  id         Int      @id @default(autoincrement())
  email      String   @unique @db.VarChar(255)
  password   String   @db.VarChar(255)
  role       Role
  first_name String   @db.VarChar(255)
  last_name  String   @db.VarChar(255)
  phone      String   @db.VarChar(20)
  rut        String   @unique @db.VarChar(12)
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  registered_patient RegisteredPatient?
  psychologist       Psychologist?

  @@map("users")
}

model UnregisteredPatient {
  id         Int      @id @default(autoincrement())
  email      String   @db.VarChar(255)
  first_name String   @db.VarChar(100)
  last_name  String   @db.VarChar(100)
  phone      String   @db.VarChar(20)
  rut        String   @db.VarChar(12)
  consent    Boolean
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  appointments Appointment[]

  @@map("unregistered_patients")
}

model RegisteredPatient {
  id               Int      @id @default(autoincrement())
  user_id          Int      @unique
  needs_assistance Boolean
  consent          Boolean
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user         User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  appointments Appointment[]

  @@map("registered_patients")
}

model Psychologist {
  id              Int      @id @default(autoincrement())
  user_id         Int      @unique
  specialization  String   @db.VarChar(150)
  bio             String   @db.Text
  photo_url       String   @db.VarChar(500)
  fonasa_code     String   @db.VarChar(20)
  fonasa_level    String   @db.VarChar(10)
  is_active       Boolean  @default(true)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user           User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  appointments   Appointment[]
  availabilities Availability[]

  @@map("psychologists")
}


enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum Modality {
  ONLINE
  PRESENCIAL
}

model Availability {
  id              Int       @id @default(autoincrement())
  psychologist_id Int
  day_of_week     DayOfWeek
  start_time      DateTime  @db.Time
  end_time        DateTime  @db.Time
  modality        Modality
  is_active       Boolean   @default(true)
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt

  // Relaciones
  psychologist Psychologist @relation(fields: [psychologist_id], references: [id], onDelete: Cascade)

  @@map("availabilities")
}


model Fonasa {
  id                Int       @id @default(autoincrement())
  appointment_id    Int       @unique
  bono_pdf_url      String    @db.VarChar(500)
  validated_at      DateTime?
  validated_by      String?   @db.VarChar(100)
  validation_notes  String?   @db.Text
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  appointment Appointment @relation(fields: [appointment_id], references: [id], onDelete: Cascade)

  @@map("fonasa")
}


enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

model Appointment {
  id                        Int                @id @default(autoincrement())
  psychologist_id           Int
  registered_patient_id     Int?
  unregistered_patient_id   Int?
  appointment_date          DateTime           @db.Date
  appointment_time          DateTime           @db.Time
  modality                  Modality
  status                    AppointmentStatus  @default(PENDING)
  blocked_until             DateTime
  patient_confirmed_at      DateTime?
  reminder_sent_at          DateTime?
  created_at                DateTime           @default(now())
  updated_at                DateTime           @updatedAt

  psychologist         Psychologist         @relation(fields: [psychologist_id], references: [id], onDelete: Cascade)
  registered_patient   RegisteredPatient?   @relation(fields: [registered_patient_id], references: [id], onDelete: Cascade)
  unregistered_patient UnregisteredPatient? @relation(fields: [unregistered_patient_id], references: [id], onDelete: Cascade)
  fonasa               Fonasa?              
  payment              Payment?

  @@map("appointments")
}


enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Payment {
  id             Int           @id @default(autoincrement())
  appointment_id Int           @unique
  amount         Decimal       @db.Decimal(10, 2)
  status         PaymentStatus @default(PENDING)
  created_at     DateTime      @default(now())
  updated_at     DateTime      @updatedAt

  appointment Appointment @relation(fields: [appointment_id], references: [id], onDelete: Cascade)
  webpay      Webpay?  

  @@map("payments")
}



model Webpay {
  id                  Int      @id @default(autoincrement())
  payment_id          Int      @unique
  token               String   @db.VarChar(255)
  buy_order           String   @db.VarChar(100)
  session_id          String   @db.VarChar(100)
  authorization_code  String?  @db.VarChar(50)
  transaction_date    DateTime?
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  payment Payment @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@map("webpay")
}

